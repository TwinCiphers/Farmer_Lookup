<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Food Marketplace</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #eef6f2;
    }
    h1 {
      color: #2a5d34;
    }
    .product-list {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .product-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(42, 93, 52, 0.15);
      padding: 15px;
      width: 180px;
      text-align: center;
    }
    .product-card img {
      width: 100%;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .price {
      color: #27ae60;
      font-weight: 600;
      margin-bottom: 10px;
    }
    input[type=number] {
      width: 60px;
      padding: 5px;
      font-size: 1em;
      margin-bottom: 10px;
    }
    button.add-to-cart {
      background-color: #2a5d34;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
    }
    button.add-to-cart:hover {
      background-color: #1f4325;
    }
    #cart-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(42, 93, 52, 0.15);
      max-width: 800px;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    th, td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }
    #order-method, #special-requests {
      margin-bottom: 12px;
      width: 100%;
      padding: 7px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #place-order {
      background-color: #27ae60;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #place-order[disabled] {
      opacity: 0.6;
      cursor: default;
    }
    #place-order:hover:not([disabled]) {
      background-color: #1e8449;
    }
    #confirmation {
      margin-top: 15px;
      font-weight: 600;
      color: #2a5d34;
    }
    .buyer-info {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    .buyer-info span {
      font-weight: 600;
    }
    .btn-small {
      padding: 6px 10px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      background-color: #eee;
    }
    .btn-small:hover { background-color: #e0e0e0; }
    .empty-cart {
      text-align: center;
      color: #666;
      padding: 12px 0;
    }
    .sr-only { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <h1>Local Food Marketplace</h1>

  <div class="product-list" id="products" aria-live="polite"></div>

  <div id="cart-container" aria-live="polite">
    <div class="buyer-info">
      <div>Buyer ID: <span id="buyer-id-display">—</span></div>
      <button id="change-buyer-id" class="btn-small" type="button">Change</button>
      <button id="reset-buyer-id" class="btn-small" type="button">Reset</button>
    </div>

    <h2>Shopping Cart</h2>
    <table id="cart-table" role="table" aria-label="Shopping cart">
      <thead>
        <tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="3"><strong>Total</strong></td>
          <td id="total-price">$0.00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div id="cart-empty-note" class="empty-cart" style="display:none;">Your cart is empty — add items to get started.</div>

    <label for="order-method" class="sr-only">Delivery or Pickup</label>
    <select id="order-method" aria-label="Delivery or Pickup">
      <option value="delivery">Delivery</option>
      <option value="pickup">Pickup</option>
    </select>

    <label for="special-requests" class="sr-only">Special requests for the farmer</label>
    <textarea id="special-requests" placeholder="Enter any special requirements for the farmer..." rows="3"></textarea>

    <div style="margin-top:12px;">
      <button id="place-order">Place Order</button>
    </div>

    <div id="confirmation" role="status" aria-live="polite"></div>
  </div>

  <script>
    // --- Products ---
    const productsData = [
      {id: 1, name: "Organic Tomatoes", price: 4.99, img: "https://via.placeholder.com/180?text=Tomatoes"},
      {id: 2, name: "Local Honey", price: 8.99, img: "https://via.placeholder.com/180?text=Honey"},
      {id: 3, name: "Fresh Eggs (Dozen)", price: 6.49, img: "https://via.placeholder.com/180?text=Eggs"}
    ];

    const productsDiv = document.getElementById("products");
    const cartTableBody = document.querySelector("#cart-table tbody");
    const totalPriceEl = document.getElementById("total-price");
    const orderMethod = document.getElementById("order-method");
    const specialRequests = document.getElementById("special-requests");
    const confirmation = document.getElementById("confirmation");
    const buyerIdDisplay = document.getElementById("buyer-id-display");
    const changeBuyerBtn = document.getElementById("change-buyer-id");
    const resetBuyerBtn = document.getElementById("reset-buyer-id");
    const placeOrderBtn = document.getElementById("place-order");
    const cartEmptyNote = document.getElementById("cart-empty-note");

    const cart = {};

    // --- Buyer ID generation / persistence ---
    const BUYER_KEY = 'lfm_buyer_id';

    function generateNumericBuyerId() {
      // create a stable-ish numeric id: last 9 digits of timestamp + small random two-digit
      const ts = Date.now().toString();
      const tail = ts.slice(-9);
      const rnd = String(Math.floor(Math.random() * 90) + 10);
      return parseInt(tail + rnd, 10);
    }

    function getOrCreateBuyerId() {
      let id = localStorage.getItem(BUYER_KEY);
      if (!id) {
        id = String(generateNumericBuyerId());
        localStorage.setItem(BUYER_KEY, id);
      }
      return parseInt(id, 10);
    }

    function setBuyerId(newId) {
      if (!newId || isNaN(newId)) return false;
      localStorage.setItem(BUYER_KEY, String(newId));
      updateBuyerDisplay();
      return true;
    }

    function resetBuyerId() {
      localStorage.removeItem(BUYER_KEY);
      updateBuyerDisplay();
    }

    function updateBuyerDisplay() {
      buyerIdDisplay.textContent = getOrCreateBuyerId();
    }

    changeBuyerBtn.addEventListener('click', () => {
      const current = getOrCreateBuyerId();
      const b = prompt('Enter numeric buyer id (leave blank to cancel):', current);
      if (b === null) return;
      const parsed = parseInt(b, 10);
      if (!isNaN(parsed) && parsed > 0) {
        setBuyerId(parsed);
      } else {
        alert('Invalid numeric id. No changes made.');
      }
    });

    resetBuyerBtn.addEventListener('click', () => {
      if (confirm('Reset buyer id (will generate a new one)?')) {
        resetBuyerId();
      }
    });

    // --- Render products ---
    function renderProducts() {
      productsDiv.innerHTML = '';
      productsData.forEach(product => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${product.img}" alt="${product.name}">
          <h3>${product.name}</h3>
          <div class="price">$${product.price.toFixed(2)}</div>
          <input type="number" id="qty-${product.id}" min="1" step="1" value="1" aria-label="Quantity for ${product.name}">
          <button class="add-to-cart" data-id="${product.id}">Add to Cart</button>
        `;
        productsDiv.appendChild(card);
      });
    }

    // --- Add to cart handler ---
    productsDiv.addEventListener("click", (e) => {
      if (e.target.classList.contains("add-to-cart")) {
        const id = parseInt(e.target.getAttribute("data-id"), 10);
        const qtyInput = document.getElementById(`qty-${id}`);
        let quantity = qtyInput ? parseInt(qtyInput.value, 10) : 1;
        if (quantity <= 0 || isNaN(quantity)) quantity = 1;
        if (cart[id]) {
          cart[id].quantity += quantity;
        } else {
          const product = productsData.find(p => p.id === id);
          cart[id] = {...product, quantity};
        }
        renderCart();
      }
    });

    // --- Remove from cart ---
    cartTableBody.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-btn")) {
        const id = parseInt(e.target.getAttribute("data-id"), 10);
        delete cart[id];
        renderCart();
      }
    });

    // --- Render cart contents ---
    function renderCart() {
      cartTableBody.innerHTML = "";
      let total = 0;
      const items = Object.values(cart);
      if (items.length === 0) {
        cartEmptyNote.style.display = '';
        // keep table body empty
      } else {
        cartEmptyNote.style.display = 'none';
        items.forEach(item => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(item.name)}</td>
            <td>${item.quantity}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>$${subtotal.toFixed(2)}</td>
            <td><button class="remove-btn" data-id="${item.id}" aria-label="Remove ${escapeHtml(item.name)}">X</button></td>
          `;
          cartTableBody.appendChild(tr);
        });
      }
      totalPriceEl.textContent = `$${total.toFixed(2)}`;
    }

    // very small helper to avoid accidental HTML injection in product names
    function escapeHtml(text) {
      return String(text).replace(/[&<>"']/g, chr => {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[chr];
      });
    }

    // --- Place order ---
    async function placeOrder() {
      if (Object.keys(cart).length === 0) {
        alert("Your cart is empty. Please add products before placing an order.");
        return;
      }

      placeOrderBtn.disabled = true;
      placeOrderBtn.textContent = 'Placing order...';

      const deliveryOption = orderMethod.value;
      const special = specialRequests.value.trim();

      const items = Object.values(cart).map(item => ({
        product_id: item.id,
        quantity: item.quantity,
        unit_price: item.price
      }));

      const buyerId = getOrCreateBuyerId();

      const payload = {
        buyer_id: buyerId,
        items: items,
        delivery_method: deliveryOption,
        special_requests: special,
        shipping_address: 'N/A',
        city: '',
        state: '',
        zip_code: ''
      };

      const doPost = async () => {
        // if the app object exposes apiCall, prefer it
        if (window.app && typeof window.app.apiCall === 'function') {
          // adapt call shape if your app.apiCall expects different args
          return await window.app.apiCall('orders.php', 'POST', payload);
        } else {
          // fallback to fetch - adjust the URL as required by your backend
          const res = await fetch('../api/orders.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          // try to parse JSON; if response not JSON, throw
          const text = await res.text();
          try {
            return JSON.parse(text || '{}');
          } catch (err) {
            return { success: false, message: 'Invalid server response' };
          }
        }
      };

      try {
        const json = await doPost();
        if (json && json.success) {
          confirmation.textContent = `Order #${json.order_id || 'N/A'} confirmed for Buyer ${buyerId} with ${deliveryOption}. Special instructions: ${special || 'None'}. Thank you for supporting local farmers!`;
          // Clear cart
          Object.keys(cart).forEach(k => delete cart[k]);
          renderCart();
        } else {
          alert('Failed to place order: ' + (json && json.message ? json.message : 'Unknown error'));
        }
      } catch (err) {
        console.error('Order API error', err);
        alert('Network error placing order');
      } finally {
        placeOrderBtn.disabled = false;
        placeOrderBtn.textContent = 'Place Order';
      }
    }

    placeOrderBtn.addEventListener('click', placeOrder);

    // --- Init UI ---
    updateBuyerDisplay();
    renderProducts();
    renderCart();

  </script>
</body>
</html>
