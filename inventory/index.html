<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Food Marketplace Inventory</title>
  <link rel="stylesheet" href="inventory.css">
</head>
<body>
  <header>
    <h1>ðŸ¥• Local Food Market Inventory</h1>
    <p>Manage and track fresh local produce</p>
  </header>

  <main>
    <section class="form-section">
      <h2>Add or Edit Product</h2>
      <form id="productForm">
        <label>Product Name</label>
        <input type="text" id="name" placeholder="e.g., Organic Tomatoes" required>

        <label>Category</label>
        <select id="category">
          <option value="">Select Category</option>
          <option>Vegetables</option>
          <option>Fruits</option>
          <option>Dairy</option>
          <option>Baked Goods</option>
          <option>Other</option>
        </select>

        <label>Price per kg ($)</label>
        <input type="number" id="price" min="0" step="0.01" required>

        <label>Available Quantity (kg)</label>
        <input type="number" id="quantity" min="0" required>

        <label>Seller Name</label>
        <input type="text" id="seller" placeholder="e.g., Green Valley Farms">

        <div class="buttons">
          <button type="submit" id="addBtn">Add Product</button>
          <button type="button" id="resetBtn">Reset</button>
        </div>
      </form>
    </section>

    <section class="table-section">
      <h2>Inventory List</h2>
      <div id="inventory-list"></div>
    </section>

    <script>
      // Wire product form to API create endpoint
      (function() {
        const productForm = document.getElementById('productForm');
        if (!productForm) return;

        productForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('name').value.trim();
          const category = document.getElementById('category').value;
          const price = parseFloat(document.getElementById('price').value) || 0;
          const quantity = parseInt(document.getElementById('quantity').value) || 0;
          const seller = document.getElementById('seller').value.trim();

          if (!name || price <= 0) {
            alert('Please provide a valid product name and price.');
            return;
          }

          // Determine farmer id: prefer logged in user, otherwise prompt for testing/demo
          let farmerId = 0;
          if (window.app && window.app.currentUser && window.app.currentUser.id) {
            farmerId = window.app.currentUser.id;
          } else {
            const f = prompt('Enter your farmer user id (numeric) or leave blank to use 0 for testing:','0');
            farmerId = f ? parseInt(f) || 0 : 0;
          }

          const payload = {
            farmer_id: farmerId,
            title: name,
            description: seller || null,
            price: price,
            unit: 'kg',
            quantity: quantity,
            category_id: null,
            is_active: 1
          };

          // Post to API (relative path from /inventory -> ../api/products/create.php)
          fetch('../api/products/create.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(r => r.json()).then(json => {
            if (json && json.success) {
              alert('Product created (id: ' + (json.product_id || 'N/A') + ').');
              productForm.reset();
            } else {
              console.error('Create product failed', json);
              alert('Failed to create product: ' + (json && json.message ? json.message : 'unknown'));
            }
          }).catch(err => {
            console.error('Network error creating product', err);
            alert('Network error creating product');
          });
        });
      })();
    </script>
