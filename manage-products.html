<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Manage Products - Farmer Lookup</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <header class="header">
    <div class="header-container">
      <div class="logo"><span class="logo-icon">ðŸšœ</span><span class="logo-text">Farmer Lookup</span></div>
      <nav>
        <ul class="nav-menu">
          <li class="nav-item"><a href="index.html">Home</a></li>
        </ul>
      </nav>
      <div class="user-actions"><a href="login.html" class="btn btn-outline">Login</a></div>
    </div>
  </header>

  <main class="container">
    <h1>Manage Products</h1>
    <p>Manage your product listings. Use this page to add, edit, and remove products.</p>

    <section id="product-manager">
      <div class="toolbar">
        <button id="btn-refresh" class="btn">Refresh</button>
        <button id="btn-new" class="btn btn-primary">New Product</button>
      </div>

      <div id="products-list">
        <table class="table" id="products-table">
          <thead>
            <tr><th>ID</th>
                <th>Title</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="product-form-wrap" style="display:none; margin-top:1rem;">
        <h3 id="form-title">New Product</h3>
        <div id="form-alert" style="display:none;margin-bottom:8px;"></div>
        <form id="product-form">
          <input type="hidden" id="p-id" />
          <label>Title</label>
          <input id="p-title" required />
          <label>Description</label>
          <input id="p-desc" />
          <label>Price</label>
          <input id="p-price" type="number" step="0.01" required />
          <label>Quantity</label>
          <input id="p-qty" type="number" required />
          <label>Unit</label>
          <input id="p-unit" value="kg" />
          <label>Image URL</label>
          <input id="p-image" />
          <label>Growing Method</label>
          <input id="p-method" />
          <label>Active</label>
          <select id="p-active"><option value="1">Yes</option><option value="0">No</option></select>
          <div style="margin-top:8px;">
            <button type="submit" class="btn btn-primary" id="btn-save">Save</button>
            <button type="button" id="btn-cancel" class="btn">Cancel</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script src="assets/js/main.js"></script>
  <script>
  (function(){
    const tableBody = document.querySelector('#products-table tbody');
    const btnRefresh = document.getElementById('btn-refresh');
    const btnNew = document.getElementById('btn-new');
    const formWrap = document.getElementById('product-form-wrap');
    const form = document.getElementById('product-form');
    const btnCancel = document.getElementById('btn-cancel');

    function apiCall(endpoint, method='GET', data=null) {
      if (window.app && typeof window.app.apiCall === 'function') return window.app.apiCall(endpoint, method, data);
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (data && method !== 'GET') opts.body = JSON.stringify(data);
      const url = '../api/' + endpoint;
      return fetch(url, opts).then(r => r.json());
    }

    async function loadProducts(){
      tableBody.innerHTML = '<tr><td colspan="6">Loadingâ€¦</td></tr>';
      try{
        const resp = await apiCall('products/search.php');
        const products = (resp && resp.products) ? resp.products : (resp.data || []);
        if (!Array.isArray(products)) products = [];
        tableBody.innerHTML = products.length ? products.map(p => productRowHtml(p)).join('') : '<tr><td colspan="6">No products</td></tr>';
      }catch(e){
        console.error('Load products failed', e);
        tableBody.innerHTML = '<tr><td colspan="6">Failed to load products</td></tr>';
      }
    }

    function productRowHtml(p){
      return `<tr data-id="${p.id}"><td>${p.id}</td><td>${escapeHtml(p.name||p.title||'')}</td><td>${p.price_per_unit || p.price || ''}</td><td>${p.quantity_available || p.quantity || 0}</td><td>${(p.is_active||p.active||1)?'Yes':'No'}</td><td><button class="edit-btn btn">Edit</button> <button class="delete-btn btn btn-danger">Delete</button></td></tr>`;
    }

    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

    btnRefresh.addEventListener('click', loadProducts);
    btnNew.addEventListener('click', ()=>{ openForm(); });
    btnCancel.addEventListener('click', ()=>{ closeForm(); });

    tableBody.addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr'); if (!tr) return;
      const id = tr.dataset.id;
      if (e.target.classList.contains('edit-btn')){
        // load product details into form
        try{
          const resp = await apiCall('products.php?id=' + encodeURIComponent(id));
          const p = resp && (resp.product || resp.data || resp.row || resp) ? (resp.product||resp.data||resp.row||resp) : null;
          if (!p) throw new Error('Product not found');
          openForm(p);
        }catch(err){ alert('Failed to load product'); console.error(err); }
      } else if (e.target.classList.contains('delete-btn')){
        if (!confirm('Delete this product?')) return;
        try{
          // Use DELETE method
          const resp = await (window.app && window.app.apiCall ? window.app.apiCall('products.php', 'DELETE', { id: id }) : fetch('../api/products.php', { method: 'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id}) }).then(r=>r.json()));
          if (resp && resp.success) { alert('Deleted'); loadProducts(); } else { alert('Failed to delete'); }
        }catch(err){ console.error(err); alert('Error deleting'); }
      }
    });

    function openForm(p){
      formWrap.style.display = 'block';
      document.getElementById('form-title').textContent = p ? 'Edit Product' : 'New Product';
      document.getElementById('p-id').value = p ? p.id : '';
      document.getElementById('p-title').value = p ? (p.name||p.title||'') : '';
      document.getElementById('p-desc').value = p ? (p.description||'') : '';
      document.getElementById('p-price').value = p ? (p.price_per_unit||p.price||'') : '';
      document.getElementById('p-qty').value = p ? (p.quantity_available||p.quantity||0) : 0;
      document.getElementById('p-unit').value = p ? (p.unit_type||p.unit||'kg') : 'kg';
      document.getElementById('p-image').value = p ? (p.image_url||'') : '';
      document.getElementById('p-method').value = p ? (p.growing_method||p.farming_method||'') : '';
      document.getElementById('p-active').value = (p && (p.is_active===0 || p.is_active===1)) ? p.is_active : (p && (p.active===0||p.active===1) ? p.active : '1');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function closeForm(){ formWrap.style.display='none'; form.reset(); }

    const saveBtn = document.getElementById('btn-save');
    const formAlert = document.getElementById('form-alert');

    function showFormAlert(msg, type='danger'){
      formAlert.style.display = 'block';
      formAlert.textContent = msg;
      formAlert.style.color = (type === 'danger') ? '#a00' : '#080';
      setTimeout(()=>{ formAlert.style.display = 'none'; }, 5000);
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // Basic validation
      const title = document.getElementById('p-title').value.trim();
      const priceVal = parseFloat(document.getElementById('p-price').value);
      if (!title) { showFormAlert('Please enter a product title.'); return; }
      if (!priceVal || priceVal <= 0) { showFormAlert('Please enter a valid price greater than 0.'); return; }
      const payload = {
        farmer_id: (window.app && window.app.currentUser && window.app.currentUser.id) ? window.app.currentUser.id : 0,
        title: document.getElementById('p-title').value.trim(),
        description: document.getElementById('p-desc').value.trim(),
        price: parseFloat(document.getElementById('p-price').value) || 0,
        quantity: parseInt(document.getElementById('p-qty').value) || 0,
        unit: document.getElementById('p-unit').value || 'kg',
        image_url: document.getElementById('p-image').value || null,
        farming_method: document.getElementById('p-method').value || null,
        is_active: parseInt(document.getElementById('p-active').value) || 0
      };
      const id = document.getElementById('p-id').value;
      try{
        // disable save to prevent duplicates
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Savingâ€¦'; }
        if (id) {
          // Update via PUT
          const resp = await (window.app && window.app.apiCall ? window.app.apiCall('products.php', 'PUT', Object.assign({ id: id }, payload)) : fetch('../api/products.php', { method: 'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(Object.assign({ id: id }, payload)) }).then(r=>r.json()));
          if (resp && resp.success) { showFormAlert('Updated', 'success'); closeForm(); loadProducts(); } else { showFormAlert('Update failed'); }
        } else {
          // Create
          const resp = await apiCall('products/create.php', 'POST', payload);
          if (resp && resp.success) { showFormAlert('Created product id: ' + (resp.product_id||resp.id||''), 'success'); closeForm(); loadProducts(); } else { showFormAlert('Create failed'); }
        }
      }catch(err){ console.error(err); showFormAlert('Save failed'); }
      finally { if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; } }
    });

    // Initial load
    loadProducts();
  })();
  </script>
</body>
</html>